<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="../_shared/shared.css">
		<script src="../../src/sage.math.js"></script>

		<script src="../../src/sage.webgl/sage.webgl.js"></script>
		<script src="../../src/sage.webgl/sage.webgl.CanvasGL.js"></script>
		<script src="../../src/sage.webgl/sage.webgl.Shader.js"></script>
		<script src="../../src/sage.webgl/sage.webgl.SquareMesh.js"></script>
		<script src="../../src/sage.webgl/sage.webgl.CubeMesh.js"></script>
		<script>
  			var cgl,shader,camera,renderLoop, rotX=0,rotY=90,rotZ=0;

  			var box1, box2;
  			var cube;

  			var matModal;

			window.addEventListener("load",function(){
				matModal = new sage.webgl.Matrix4();
				//matModal.scale(.5,.5,.5).rotateX(-30 * (Math.PI/180)).rotateY(30 * (Math.PI/180)).translate(0,0,0.5);
				matModal.scale(1,1,1).rotateX(-30 * (Math.PI/180)).rotateY(30 * (Math.PI/180)).translate(0,0,-8);
				//matModal.translate(0,0,-20);
				var matPerspective = new sage.webgl.Matrix4();
				sage.webgl.Matrix4.perspective(matPerspective.raw,Math.PI * 0.5,500/500,0.1,100.00);

				var matOrtho = new sage.webgl.Matrix4();
				//sage.webgl.Matrix4.ortho(matOrtho.raw,-1,1,-1,1,0.1,100);
				//sage.webgl.Matrix4.ortho(matOrtho.raw,0,500,0,500,0.1,100);
				sage.webgl.Matrix4.ortho(matOrtho.raw,-4,4,-4,4,0.1,100);
				
				//console.log(matOrtho.raw);


				var cameraview = new sage.webgl.Matrix4();
				//cameraview.rotateX(-20 * (Math.PI /180)).translate(0,3,3);
				cameraview.translate(1,1,5);
				//console.log(cameraview.raw);
				sage.webgl.Matrix4.invert(cameraview.raw,cameraview.raw);
				//console.log(cameraview.raw);


					//console.log(matPerspective.raw);

				//var camera  = new sage.webgl.Camera()
				//	.setPerspective(45,500/500,0.1,100.00);
				//console.log(camera.mPerspectiveMat4);

				var simpleProjection = [
				1, 0, 0, 0,
				0, 1, 0, 0,
				0, 0, 1, 0.5,
				0, 0, 0, 0.5,
				];

				//Prepare WebGL and Camera
				cgl = new sage.webgl.CanvasGL("canvas01")
					.setSize(500,500)
					.setBackgroundColor(0,0,0,0);

				camera  = new sage.webgl.Camera()
					.setPosition(0.0,0.0,-5.0)
					.setPerspective(45,500/500,0.1,100.00);

				//Procedurally Generated Cube
				//box1 = new SquareMesh(cgl,1,1,0);
				//box2 = new SquareMesh(cgl,2,1.5,0.3);

				cube = new CubeMesh(cgl,2,2,2);

				//Define the shader that will render the mesh
				shader = new sage.webgl.Shader(cgl);
				shader.createProgram("vertShader","fragShader",false);
				shader.attribFAryBuf("aVertexPosition",3,cube.cubeVertBuffer);
				shader.attribFAryBuf("aVertexColor",4,cube.colorBuffer);

				shader.addUniformMatrix4fv("view",cameraview.raw);
				
				shader.addUniformMatrix4fv("model",matModal.raw);
				//shader.addUniformMatrix4fv("projection",simpleProjection);
				//shader.addUniformMatrix4fv("projection",matPerspective.raw);
				shader.addUniformMatrix4fv("projection",matOrtho.raw);

				////shader.addUniformMatrix4fv("uMVMatrix",camera.getViewMatrix());
				//shader.addUniformMatrix4fv("uPMatrix",camera.getPerspectiveMatrix());

  				//Animation Loop handler
				//renderLoop = new sage.webgl.RenderLoop(onDraw);
				//renderLoop.start();

				draw();
			});


			function draw(){
				//delta *= 0.4; //Slow down the rotation speed
				cgl.clear(); //clear the scene
	
				//Render the cube.
				cube.draw(cgl);

				//shader.attribFAryBuf("aVertexPosition",3,box2.cubeVertBuffer);
				//shader.attribFAryBuf("aVertexColor",4,box2.colorBuffer);
				//box2.draw(cgl);
			}


			function onDraw(delta){
				//delta *= 0.4; //Slow down the rotation speed
				cgl.clear(); //clear the scene

				//Rotate the camera position then update the shader with its position.
				camera.rotateY(rotY * delta).rotateZ(rotZ * delta).rotateX(rotX*delta);
				shader.updateUniformMatrix4fv("uMVMatrix",camera.getViewMatrix());
					
				//Render the cube.
				meshCube.draw(cgl);
			}

			//UI control stuff
			function preview(o){ o.previousSibling.innerHTML = o.value; }
			function reset(){
				var o = document.getElementById("yrot");
				o.value = rotY = 90; preview(o);

				o = document.getElementById("xrot");
				o.value = rotX = 0; preview(o);

				o = document.getElementById("zrot");
				o.value = rotZ = 0; preview(o);

				o = document.getElementById("zpos");
				o.value = -5; preview(o);

				camera.setPosition(0,0,-5);
				camera.mViewMat4.resetRotation();
			}
		</script>
	</head>
<body>

<script id="vertShader" type="x-shader/x-vertex">
	attribute vec3 aVertexPosition;
	attribute vec4 aVertexColor;
	uniform mat4 view;
	uniform mat4 model;
	uniform mat4 projection;

	varying lowp vec4 vColor;

	void main(void) {
		vec4 trans = projection * view * model * vec4(aVertexPosition,1.0);

		//float scaleFactor = 0.8;

		//float w = (1.0 + trans.z) * scaleFactor;

		//gl_Position = trans; //model * vec4(aVertexPosition, 1);
		//gl_Position = vec4(trans.xyz,w);
		gl_Position = trans;
		vColor = aVertexColor;
	}
</script>

<script id="fragShader" type="x-shader/x-fragment">
	varying lowp vec4 vColor;
	void main(void) {
		gl_FragColor = vColor; //vec4(1.0, 1.0, 1.0, 1.0);
	}
</script>


<div class="rowFlex" style="width:800px; margin:0px auto;">
	<section style="width:500px;">
		<div class="NodeContainer" style="display:inline-block;">
			<header>WebGL Enabled Canvas</header>
			<canvas id="canvas01"></canvas>
		</div>
	</section>

	<section>
		<div class="NodeContainer">
			<header style="margin-bottom:20px;">Camera Control</header>
			<div class="ctrRow">
				<span>Y Rotation: </span><label>90</label><input id="yrot" class="slider" type="range" min="0" max="180" value="90" onInput="preview(this);" onChange="rotY = this.value;"/>
			</div>
			<div class="ctrRow">
				<span>X Rotation: </span><label>0</label><input id="xrot" class="slider" type="range" min="0" max="180" value="0" onInput="preview(this);" onChange="rotX = this.value;"/>
			</div>
			<div class="ctrRow">
				<span> Z Rotation: </span><label>0</label><input id="zrot" class="slider" type="range" min="0" max="180" value="0" onInput="preview(this);" onChange="rotZ = this.value;"/>
			</div>

			<div class="ctrRow">
				<span>Z Position: </span><label>-5</label><input id="zpos" class="slider" type="range" min="-15" max="0" value="-5" onInput="preview(this);" onChange="camera.setPosition(0.0,0.0,this.value)"/>
			</div>

			<div class="ctrRow full">
				<input type="button" id="btn1" onClick="reset(); this.blur();" value="Reset" style="display:block;">
			</div>
		</div>
	<section>
</div>

<div class="rowFlex">
	<section>
		<p style="color:#a0a0a0; bottom:1px;">
			<i style="color:lime;">WebGL Experiments : Build a viewer from scratch</i><br>
			
			Wanting to move into VR and AR development, I've begun studing game and graphic programming. While I use Unity3D/Unreal engines as a way
			to learn the front end of things I'm going to use WebGL as a way to learn the backend. So the idea is to build a web based 3D modal viewer from
			scratch. So far I have a working canvas, shaders and a procedurally generated cube with random colors for each face. For demonstration I added
			controls for rotation and distance of the camera, so the cube itself isn't moving at all... ITS ALL AN ILLUSION :)
			<br><br>

			- <a href="https://github.com/sketchpunk/SageJS" style="color:orange;text-decoration:none;">Source on Github</a><br><br>

			<br><br>&copy; 2016 Sketchpunk Labs;
		</p>
	</section>
</div>

</body>
</html>